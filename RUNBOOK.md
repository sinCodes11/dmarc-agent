# Client Delivery Runbook — DMARC Security Service

Step-by-step guide from signed client to fully protected domain.
Follow this in order. Do not skip phases.

---

## Before You Touch Anything

Collect these from the client before running a single command:

- [ ] Their domain name(s) — e.g. `clientbusiness.com`
- [ ] Who manages their DNS — Cloudflare, GoDaddy, Namecheap, Route 53, etc.
- [ ] Their email provider — Google Workspace, Microsoft 365, Zoho, other
- [ ] Any third-party email senders — Mailchimp, HubSpot, SendGrid, Zendesk, Xero, etc.
- [ ] An email address for DMARC reports — ideally `dmarc@theirdomain.com` (create it if needed)
- [ ] DNS login credentials or confirm client will make DNS changes with you on a call

---

## Step 1 — Run the Initial Analysis

```bash
# Terminal output — read this yourself first
dmarc-agent analyze <domain>

# Save HTML report to send to client
dmarc-agent analyze <domain> --format html --output reports/<client>-initial.html

# Save JSON for your records
dmarc-agent analyze <domain> --format json --output reports/<client>-initial.json
```

Note the **risk level** (HIGH / MEDIUM / LOW) and read every issue listed.

If they have a known DKIM selector (common ones: `google`, `selector1`, `selector2`, `mail`):
```bash
dmarc-agent analyze <domain> --dkim-selector google
```

---

## Step 2 — Brief the Client

Open the HTML report and walk the client through it.

**What to say (no jargon):**

> "Right now, anyone can send emails that look like they're coming from your domain.
> That means scammers can impersonate you to phish your customers or staff.
> We're going to lock that down in stages over the next 4–6 weeks.
> The first changes won't affect your email at all — we're just turning on monitoring."

Get their verbal/written sign-off before making any DNS changes.

---

## Step 3 — Deploy DMARC Stage 1 (Week 1)

**Goal: Start collecting data. Zero disruption.**

Add this TXT record to their DNS:

```
Type:  TXT
Name:  _dmarc
Value: v=DMARC1; p=none; rua=mailto:dmarc@<domain>; ruf=mailto:dmarc@<domain>; fo=1
TTL:   3600
```

After 15–60 minutes, verify it's live:
```bash
dmarc-agent check-dmarc <domain>
```

Tell the client to expect DMARC report emails arriving at `dmarc@<domain>` within 24–48 hours.
These look like XML attachments — forward them to you or save them.

**Wait: 2–4 weeks before moving to Step 4.**

---

## Step 4 — Review DMARC Reports

Once reports arrive, parse them:
```bash
dmarc-agent parse-report /path/to/report.xml.gz
dmarc-agent parse-report /path/to/report.xml.gz --format json
```

Look for:
- Any senders you don't recognise → ask the client if they're legitimate
- SPF or DKIM failures from known services → these need to be fixed before enforcement
- Overall pass rate — aim for >95% before progressing

---

## Step 5 — Harden SPF (Week 2)

**Goal: Switch from softfail (~all) to hard fail (-all).**

Only do this after you've confirmed all legitimate senders from the DMARC reports.

The agent's output will show the recommended SPF record. It looks like:
```
v=spf1 include:_spf.google.com include:sendgrid.net -all
```

Update the existing SPF TXT record on `@` (root domain):
- Do NOT create a second SPF record — replace the existing one
- Add all senders the client uses based on the DMARC report data

After updating:
```bash
dmarc-agent check-spf <domain>
```

Send a test email from every service the client uses (Gmail, Mailchimp, etc.) and confirm delivery.
Monitor for 48 hours — if anything breaks, the old record is in your JSON report to roll back.

---

## Step 6 — Set Up DKIM (Week 2–3)

**Goal: Cryptographic email signing.**

DKIM keys are generated by the email provider, not this tool.

**Google Workspace:**
Admin Console → Apps → Google Workspace → Gmail → Authenticate email → Generate new record

**Microsoft 365:**
Admin Center → Settings → Domains → click domain → DNS records tab

The provider gives you a TXT record like:
```
Type:  TXT
Name:  google._domainkey.<domain>
Value: v=DKIM1; k=rsa; p=MIGfMA0GCSq...
```

Add it to DNS, then verify:
```bash
dmarc-agent verify-dkim google <domain>
```

Confirm DKIM is passing in the next DMARC report before moving to enforcement.

---

## Step 7 — DMARC Enforcement (Week 4–6)

**Goal: Move from monitoring to blocking spoofed email.**

Only proceed if DMARC reports show:
- Pass rate consistently >95%
- All legitimate senders passing SPF or DKIM
- No unexplained failures

**Stage 2 — Partial quarantine (10% of failing mail):**
```
v=DMARC1; p=quarantine; pct=10; rua=mailto:dmarc@<domain>; ruf=mailto:dmarc@<domain>; fo=1
```
Wait 1–2 weeks. No client complaints? Move on.

**Stage 3 — Full quarantine (100% of failing mail → spam folder):**
```
v=DMARC1; p=quarantine; rua=mailto:dmarc@<domain>; ruf=mailto:dmarc@<domain>; fo=1
```
Wait 4–8 weeks. Still clean? Move on.

**Stage 4 — Full reject (maximum protection):**
```
v=DMARC1; p=reject; rua=mailto:dmarc@<domain>; ruf=mailto:dmarc@<domain>; fo=1
```

Verify each stage:
```bash
dmarc-agent check-dmarc <domain>
```

---

## Step 8 — Final Report and Handoff

Run a final analysis and generate the deliverable:
```bash
dmarc-agent analyze <domain> --dkim-selector <selector> --format html --output reports/<client>-final.html
```

The final report should show **LOW RISK**.

Send the client:
- `reports/<client>-final.html` — their security report
- A plain-English summary of what was done and what's now protected
- Instructions for who to contact if they add a new email service

---

## Step 9 — Set Up Ongoing Monitoring (Optional but Recommended)

**Manual (minimum viable):**
```bash
# Run weekly or monthly
dmarc-agent analyze <domain>
```

Add the domain to `config/domains.json` for batch tracking:
```json
{
  "domain": "<domain>",
  "owner": "Client Name",
  "contact_email": "their@email.com",
  "priority": "normal",
  "dkim_selector": "google"
}
```

**Automated (if running the n8n stack):**
- Add domain to the Load Domain List node in Workflow 1
- Forward their DMARC report emails to the monitored mailbox for Workflow 2
- See `n8n/README.md` for full setup

---

## Things That Will Go Wrong

| Problem | Fix |
|---------|-----|
| Client adds a new email tool and mail starts bouncing | Run `check-spf`, add the new sender's include to SPF |
| DMARC reports stop arriving | Check the `rua=` email address is valid and receiving |
| DKIM check fails after it was passing | Provider may have rotated the key — get the new record |
| Client switches email provider | Repeat Steps 5 and 6 for new provider before removing old SPF/DKIM |
| Pass rate drops below 95% | Parse recent reports, identify the new failing source |

---

## Your File Naming Convention

```
reports/
  <client-slug>-initial.html     # Before any changes
  <client-slug>-initial.json
  <client-slug>-YYYY-MM.json     # Monthly snapshots
  <client-slug>-final.html       # At completion
```

---

## Quick Command Reference

```bash
dmarc-agent analyze <domain>                          # Full analysis
dmarc-agent analyze <domain> --dkim-selector google   # With DKIM check
dmarc-agent analyze <domain> --format html --output report.html
dmarc-agent check-spf <domain>                        # SPF only
dmarc-agent check-dmarc <domain>                      # DMARC only
dmarc-agent verify-dkim <selector> <domain>           # DKIM only
dmarc-agent parse-report report.xml.gz                # Parse aggregate report
```
